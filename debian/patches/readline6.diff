From: Felix Krull <f_krull@gmx.de>
Date: Fri, 27 Apr 2018 08:24:06 -0700
Subject: readline6

# DP: Fix issues with readline6
---
 Modules/readline.c | 9 ++++++---
 configure.in       | 4 ++++
 pyconfig.h.in      | 3 +++
 3 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/Modules/readline.c b/Modules/readline.c
index 853874b..2687b53 100644
--- a/Modules/readline.c
+++ b/Modules/readline.c
@@ -674,6 +674,12 @@ on_completion(char *text, int state)
 static char **
 flex_complete(char *text, int start, int end)
 {
+#ifdef HAVE_RL_COMPLETION_APPEND_CHARACTER
+	rl_completion_append_character ='\0';
+#endif
+#ifdef HAVE_RL_COMPLETION_SUPPRESS_APPEND
+	rl_completion_suppress_append = 0;
+#endif
 	Py_XDECREF(begidx);
 	Py_XDECREF(endidx);
 	begidx = PyInt_FromLong((long) start);
@@ -716,9 +722,6 @@ setup_readline(void)
 	rl_completer_word_break_characters =
 		strdup(" \t\n`~!@#$%^&*()-=+[{]}\\|;:'\",<>/?");
 		/* All nonalphanums except '.' */
-#ifdef HAVE_RL_COMPLETION_APPEND_CHARACTER
-	rl_completion_append_character ='\0';
-#endif
 
 	begidx = PyInt_FromLong(0L);
 	endidx = PyInt_FromLong(0L);
diff --git a/configure.in b/configure.in
index 23c9756..d752283 100644
--- a/configure.in
+++ b/configure.in
@@ -3152,6 +3152,10 @@ then
   [readline/readline.h],
   AC_DEFINE(HAVE_RL_COMPLETION_APPEND_CHARACTER, 1,
   [Define if you have readline 2.2]), )
+  AC_EGREP_HEADER([extern int rl_completion_suppress_append;],
+  [readline/readline.h],
+  AC_DEFINE(HAVE_RL_COMPLETION_SUPPRESS_APPEND, 1,
+  [Define if you have rl_completion_suppress_append]), )
 fi
 
 # check for readline 4.0
diff --git a/pyconfig.h.in b/pyconfig.h.in
index 1bf5432..9cd19d6 100644
--- a/pyconfig.h.in
+++ b/pyconfig.h.in
@@ -423,6 +423,9 @@
 /* Define if you have readline 4.2 */
 #undef HAVE_RL_COMPLETION_MATCHES
 
+/* Define if you have rl_completion_suppress_append */
+#undef HAVE_RL_COMPLETION_SUPPRESS_APPEND
+
 /* Define if you have readline 4.0 */
 #undef HAVE_RL_PRE_INPUT_HOOK
 
